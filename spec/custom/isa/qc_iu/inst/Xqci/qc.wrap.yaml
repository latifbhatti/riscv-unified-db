# Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.
# SPDX-License-Identifier: BSD-3-Clause-Clear

# yaml-language-server: $schema=../../../../../schemas/inst_schema.json

$schema: inst_schema.json#
kind: instruction
name: qc.wrap
long_name: Wraparound (Register)
description: |
  If `xs1` >= `xs2` perform subtraction between `xs1` and `xs2`.
  If `xs1` < 0, perform addition between `xs1` and `xs2`,
  else, select `xs1`. The result is stored in `xd`.
definedBy:
  allOf:
    - xlen: 32
    - extension:
        name: Xqcia
format:
  size: 32
  operands:
    - $ref: inst_operand/qc.xs2-n0.yaml#
    - $ref: inst_operand/xs1.yaml#
    - $ref: inst_operand/xd-n0.yaml#
  opcodes:
    - displayName: funct7
      location: 31-25
      value: 0b0010010
    - displayName: funct3
      location: 14-12
      value: 0b011
    - $ref: inst_opcode/custom-0.yaml#
assembly: xd, xs1, xs2
access:
  s: always
  u: always
  vs: always
  vu: always
operation(): |
  XReg xs1_value = X[xs1];
  X[xd] = ($signed(xs1_value) >= $signed(X[xs2]))
    ? xs1_value - X[xs2]
    : (($signed(xs1_value) < 's0)
       ? (xs1_value + X[xs2])
       : xs1_value);

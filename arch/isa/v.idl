%version: 1.0

# ***************************  Mask Policy Handling  ****************************************
function handle_mask_policy {
    returns U32
    arguments
        U32 original_value
    description {
        Determines the value for masked elements based on mask policy.
        Returns the original value if undisturbed, or all 1s if agnostic.
    }
    body {
        Bits<1> Mask_policy = 0 ; # from vtype vcsr
        if (Mask_policy == 0) {   # Mask undisturbed
            return original_value;
        } else {  # Mask agnostic
            return 0xFFFFFFFF;
        }
    }
}

# *********************************  Tail Element Handling  **************************************
function handle_tail_elements {
    returns U32
    arguments
        U32 original_value
    description {
        Determines the value for tail elements based on the selected tail policy.
        Returns the original value if undisturbed, or all 1s if agnostic.
        Apply the tail policy when Vstart > vl.
    }
    body {
        Bits<1> TU = 0; # from vtype vcsr
        if (TU == 0) {  # Tail undisturbed
            return original_value;
        } else {  # Tail agnostic
            return 0xFFFFFFFF;  # All 1s pattern
        }
    }
}

# perform operation on vector elements
function process_vector_elements {
    returns U32
    arguments
        U32 result,
        U32 vs3_data,
        Bits<1> vs0_mask_bit,
        U32 encoding
    description {
        Incorporates masking logic and handles conditional execution based on mask bit 25.
        Checks the tail policy and applies either tail-agnostic or tail-undisturbed behavior accordingly.
        Returns the final processed 32-bit result after applying all vector rules.
        Implements tail policy when storing values in vector registers.
        Retains body Elements if within vector length (VL), otherwise applies tail policy.
    }
    body {
        U32 vstart = 0;  # from vcsr
        U32 vl = 4;      # from vcsr
        if (vstart <= vl){
            if (encoding[25] == 1) {  # Masking enabled
                if (vs0_mask_bit==1) {  # Active element
                    return result;
                } else {  # Masked element: apply mask policy
                    return handle_mask_policy(vs3_data);
                }
            } else {  # Masking disabled
                return result;
            }
        }
        else {  # Tail element
            return handle_tail_elements(result);
        }
    }
}




function perform_vector_operation {
    returns U32
    arguments
        U32 result,
        U32 vs3_data,
        Bits<1> vs0_mask_bit,
        U32 encoding
    description {
        Performs vector operation based on input vector registers and mask.
        Accepts 2 data vectors elements (result, vs3) and a mask vector (vs0).
        The operation behavior is influenced by the mask instruction bit (bit 25).
    }
    body {
        return process_vector_elements(result,vs3_data,vs0_mask_bit,encoding);
    }
}
